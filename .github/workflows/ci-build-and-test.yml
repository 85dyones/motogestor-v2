name: CI - build, test & publish

on:
  pull_request: {}
  push:
    # publish will only run for tags (release/semantic tags). Avoid publishing on every push to main.
    tags:
      - "v*.*.*"

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
      IMAGE_BASE: ${{ github.repository }}

    strategy:
      matrix:
        service:
          - name: users-service
            path: users-service
            has_tests: true
          - name: api-gateway
            path: api-gateway
            has_tests: true
          - name: management-service
            path: management-service
            has_tests: true
          - name: financial-service
            path: financial-service
            has_tests: true
          - name: teamcrm-service
            path: teamcrm-service
            has_tests: true
          - name: ai-service
            path: ai-service
            has_tests: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build image (no push)
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.service.path }}
          push: false
          load: true
          tags: motogestor-${{ matrix.service.name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Show image build info
        run: |
          echo "Built context: ${{ matrix.service.path }}"

      - name: Build test image (target=test)
        if: ${{ matrix.service.has_tests == true }}
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.service.path }}
          push: false
          target: test
          load: true
          tags: motogestor-${{ matrix.service.name }}-test:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run tests (if present) on the repo
        if: ${{ matrix.service.has_tests == true }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install and run tests from workspace
        if: ${{ matrix.service.has_tests == true }}
        run: |
          # run tests locally in the workspace (tests exist under the service directory)
          python -m pip install --upgrade pip
          if [ -f "${{ matrix.service.path }}/requirements.txt" ]; then
            python -m pip install -r "${{ matrix.service.path }}/requirements.txt"
          fi
          python -m pytest -q "${{ matrix.service.path }}/tests"

      - name: Run tests inside built test image
        if: ${{ matrix.service.has_tests == true }}
        run: |
          docker run --rm motogestor-${{ matrix.service.name }}-test:${{ github.sha }} pytest -q

      - name: Show image build info
        run: |
          echo "Built context: ${{ matrix.service.path }}"

      - name: Verify image is present
        run: |
          docker images --format '{{"{{.Repository}}:{{.Tag}}"}}' | grep -E "motogestor-${{ matrix.service.name }}:${{ github.sha }}" || true
  publish:
    name: Build & push images to GHCR
    runs-on: ubuntu-latest
    needs: build-and-test
    # publish should only run when pushing tags (e.g. 'v1.2.3')
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
    permissions:
      contents: read
      packages: write

    env:
      REGISTRY: ghcr.io
      IMAGE_BASE: ${{ github.repository }}

    strategy:
      matrix:
        service:
          - name: users-service
            path: ./users-service
          - name: api-gateway
            path: ./api-gateway
              has_tests: true
            path: ./management-service
          - name: financial-service
              has_tests: true
          - name: teamcrm-service
            path: ./teamcrm-service
          - name: ai-service
            path: ./ai-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Ensure CR_PAT secret is set
        run: |
          if [ -z "${{ secrets.CR_PAT }}" ]; then
            echo "CR_PAT secret is not set. Create a personal access token and add it to repo secrets as CR_PAT.";
            exit 1;
          fi

      - name: Log in to Container Registry (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          # Require a personal token CR_PAT stored in repo secrets for publishing
          password: ${{ secrets.CR_PAT }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}-${{ matrix.service.name }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push ${{ matrix.service.name }}
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.service.path }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  integration-tests:
    name: Integration tests (Postgres)
    runs-on: ubuntu-latest
    needs: build-and-test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: motogestor
          POSTGRES_PASSWORD: motogestor_pwd
          POSTGRES_DB: motogestor_integration
        ports: ["5432:5432"]
        options: >-
          --health-cmd pg_isready -U motogestor
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install users-service deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r users-service/requirements.txt

      - name: Wait for Postgres to be available
        run: |
          for i in {1..30}; do
            python -c "import sys, psycopg2; sys.exit(0) if __import__('psycopg2').connect('dbname=motogestor_integration user=motogestor password=motogestor_pwd host=127.0.0.1') else sys.exit(1)" && break || sleep 1

      - name: Run integration tests
        run: |
          pytest -q users-service/tests/integration

  e2e-tests:
    name: E2E (Postgres + users-service + api-gateway)
    runs-on: ubuntu-latest
    needs: build-and-test

    env:
      E2E_TAG: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js (build frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend (api-gateway expects frontend/dist)
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Set up QEMU and Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build users-service image for E2E
        uses: docker/build-push-action@v4
        with:
          context: ./users-service
          push: false
          load: true
          tags: motogestor-users-e2e:${{ env.E2E_TAG }}

      - name: Build api-gateway image for E2E
        uses: docker/build-push-action@v4
        with:
          context: ./api-gateway
          push: false
          load: true
          tags: motogestor-gateway-e2e:${{ env.E2E_TAG }}

      - name: Build management-service image for E2E
        uses: docker/build-push-action@v4
        with:
          context: ./management-service
          push: false
          load: true
          tags: motogestor-management-e2e:${{ env.E2E_TAG }}

      - name: Build management-service image for E2E
        uses: docker/build-push-action@v4
        with:
          context: ./management-service
          push: false
          load: true
          tags: motogestor-management-e2e:${{ env.E2E_TAG }}

      - name: Create network for E2E
        run: |
          docker network create e2e-net || true

      - name: Start Postgres
        run: |
          docker run -d --name e2e-postgres --network e2e-net -e POSTGRES_USER=motogestor -e POSTGRES_PASSWORD=motogestor_pwd -e POSTGRES_DB=motogestor_integration postgres:15

      - name: Start Redis
        run: |
          docker run -d --name e2e-redis --network e2e-net redis:7

      - name: Wait for Postgres
        run: |
          for i in {1..30}; do docker exec e2e-postgres pg_isready -U motogestor && break || sleep 1; done

      - name: Start users-service (E2E)
        run: |
          docker run -d --name e2e-users --network e2e-net -e APP_ENV=development -e DATABASE_URL="postgresql://motogestor:motogestor_pwd@e2e-postgres:5432/motogestor_integration" -p 5001:5001 motogestor-users-e2e:${{ env.E2E_TAG }}

      - name: Start management-service (E2E)
        run: |
          docker run -d --name e2e-management --network e2e-net -e APP_ENV=development -e DATABASE_URL="postgresql://motogestor:motogestor_pwd@e2e-postgres:5432/motogestor_integration" -p 5002:5002 motogestor-management-e2e:${{ env.E2E_TAG }}

      - name: Wait for users-service
        run: |
          for i in {1..30}; do curl -sSf http://localhost:5001/health && break || sleep 1; done

      - name: Start api-gateway (E2E)
        run: |
          docker run -d --name e2e-gateway --network e2e-net -e APP_ENV=development -e USERS_SERVICE_URL=http://e2e-users:5001 -e JWT_SECRET_KEY=dev-secret -p 8080:5000 motogestor-gateway-e2e:${{ env.E2E_TAG }}

      - name: Wait for api-gateway
        run: |
          for i in {1..30}; do curl -sSf http://localhost:8080/health && break || sleep 1; done

      - name: Start management-service (E2E)
        run: |
          docker run -d --name e2e-management --network e2e-net -e APP_ENV=development -e DATABASE_URL="postgresql://motogestor:motogestor_pwd@e2e-postgres:5432/motogestor_integration" -p 5002:5002 motogestor-management-e2e:${{ env.E2E_TAG }}

      - name: Wait for management-service
        run: |
          for i in {1..30}; do curl -sSf http://localhost:5002/health && break || sleep 1; done

      - name: Seed demo user via users-service and login via gateway (E2E flow)
        run: |
          # Seed demo user directly
          curl -sSf -X POST http://localhost:5001/users/seed-demo
          # Login via api-gateway (forwards to users-service)
          curl -sSf -X POST http://localhost:8080/auth/login -H "Content-Type: application/json" -d '{"email": "demo@motogestor.com", "password": "demo123"}' | jq .
          # Confirm gateway forwarding to management-service (health)
          curl -sSf http://localhost:8080/management/health | jq .

          # Check management-service health via gateway proxy
          curl -sSf http://localhost:8080/management/health

      - name: Cleanup E2E containers
        if: always()
        run: |
          docker rm -f e2e-gateway e2e-users e2e-postgres e2e-redis || true
