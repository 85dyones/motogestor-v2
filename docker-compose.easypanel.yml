version: "3.9"

x-image-tag: &image_tag ${IMAGE_TAG:-0.0.1}

# Compose file prepared for Easypanel deployments.
# Uses GHCR images by default (tagged with IMAGE_TAG, default 0.0.1) to avoid accidental pulls of :latest.
# If you prefer Easypanel to build from Dockerfiles on the server, replace `image:` with `build:` blocks.

services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - pgdata-easypanel:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-motogestor}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7
    restart: unless-stopped
    env_file:
      - .env
    command: ["redis-server", "--save", "20", "1", "--loglevel", "warning"]
    volumes:
      - redisdata-easypanel:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  users-service:
    image: ghcr.io/85dyones/motogestor-v2-users:*image_tag
    restart: unless-stopped
    env_file:
      - .env
    environment:
      APP_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      LOG_LEVEL: INFO
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  management-service:
    image: ghcr.io/85dyones/motogestor-v2-management:*image_tag
    restart: unless-stopped
    env_file:
      - .env
    environment:
      APP_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      LOG_LEVEL: INFO
    depends_on:
      - postgres

  financial-service:
    image: ghcr.io/85dyones/motogestor-v2-financial:*image_tag
    restart: unless-stopped
    env_file:
      - .env
    environment:
      APP_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      LOG_LEVEL: INFO
    depends_on:
      - postgres

  teamcrm-service:
    image: ghcr.io/85dyones/motogestor-v2-teamcrm:*image_tag
    restart: unless-stopped
    env_file:
      - .env
    environment:
      APP_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      LOG_LEVEL: INFO
    depends_on:
      - postgres

  ai-service:
    image: ghcr.io/85dyones/motogestor-v2-ai:*image_tag
    restart: unless-stopped
    env_file:
      - .env
    environment:
      APP_ENV: production
      LOG_LEVEL: INFO
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    depends_on:
      - users-service

  api-gateway:
    image: ghcr.io/85dyones/motogestor-v2-gateway:*image_tag
    restart: unless-stopped
    env_file:
      - .env
    environment:
      APP_ENV: production
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      USERS_SERVICE_URL: http://users-service:5000
      MANAGEMENT_SERVICE_URL: http://management-service:5000
      FINANCIAL_SERVICE_URL: http://financial-service:5000
      TEAMCRM_SERVICE_URL: http://teamcrm-service:5000
      AI_SERVICE_URL: http://ai-service:5000
      FRONTEND_DIST_PATH: /app/frontend/dist
      LOG_LEVEL: INFO
    depends_on:
      - users-service
      - management-service
      - financial-service
      - teamcrm-service
      - ai-service
    ports:
      - "80:5000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 15s
      timeout: 5s
      retries: 5

volumes:
  pgdata-easypanel:
  redisdata-easypanel:

# Notes:
# - Replace the `ghcr.io/...` image placeholders with your actual image names/tags.
# - If you prefer Easypanel to build from Dockerfiles on the server, replace `image:` with `build:` blocks.
# - Easypanel supports defining env vars and secrets per service â€” put secrets there instead of in `.env` when possible.
